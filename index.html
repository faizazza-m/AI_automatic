<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Review Assistant - Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .code-line { 
            padding: 2px 8px; 
            border-left: 3px solid transparent;
        }
        .issue-critical { border-left-color: #ef4444; background: #fef2f2; }
        .issue-warning { border-left-color: #f59e0b; background: #fffbeb; }
        .issue-info { border-left-color: #3b82f6; background: #eff6ff; }
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-lg shadow-lg p-6 mb-6 text-white">
            <h1 class="text-3xl font-bold mb-2">üîç Code Review Assistant</h1>
            <p class="text-blue-100">Tool tinjauan kode otomatis untuk Marketplace Project Anda</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Panel - Input -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Quick Context Selector -->
                <div class="bg-white rounded-lg shadow p-5">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">‚öôÔ∏è</span>
                        Konteks Review
                    </h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">Bahasa</label>
                            <select id="language" class="w-full border rounded-lg px-3 py-2 bg-white">
                                <option value="javascript">JavaScript/Node.js</option>
                                <option value="typescript">TypeScript</option>
                                <option value="python">Python</option>
                                <option value="php">PHP</option>
                                <option value="java">Java</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Modul</label>
                            <select id="module" class="w-full border rounded-lg px-3 py-2 bg-white">
                                <option value="general">General</option>
                                <option value="auth">Authentication</option>
                                <option value="payment">Payment/Checkout</option>
                                <option value="order">Order Processing</option>
                                <option value="product">Product Management</option>
                                <option value="api">API Endpoint</option>
                                <option value="database">Database Query</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium mb-2">Fokus Review</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="check-security" checked class="rounded">
                                <span>üîí Security</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="check-bugs" checked class="rounded">
                                <span>üêõ Bugs</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="check-performance" checked class="rounded">
                                <span>‚ö° Performance</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="check-bestpractice" checked class="rounded">
                                <span>‚ú® Best Practices</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Code Input -->
                <div class="bg-white rounded-lg shadow p-5">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üíª</span>
                        Kode yang Akan Di-Review
                    </h2>
                    <textarea 
                        id="codeInput" 
                        rows="16" 
                        class="w-full border rounded-lg px-4 py-3 font-mono text-sm bg-gray-50"
                        placeholder="Paste kode Anda di sini...

Contoh untuk modul Payment:
router.post('/checkout', async (req, res) => {
    const { cart, userId } = req.body;
    const total = cart.reduce((sum, item) => sum + item.price, 0);
    await db.query('INSERT INTO orders VALUES (?, ?)', [userId, total]);
    res.json({ success: true });
});"
                    ></textarea>
                    
                    <div class="mt-4 flex gap-3">
                        <button 
                            id="reviewBtn" 
                            class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2"
                        >
                            <span id="btnText">üöÄ Review Kode dengan AI</span>
                            <span id="btnLoader" class="hidden">‚è≥</span>
                        </button>
                        <button 
                            id="clearBtn" 
                            class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                        >
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>

                <!-- Results -->
                <div id="resultsSection" class="hidden bg-white rounded-lg shadow p-5">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üìã</span>
                        Hasil Review
                    </h2>
                    <div id="resultsContent" class="space-y-4"></div>
                </div>
            </div>

            <!-- Right Panel - Checklist & Guide -->
            <div class="space-y-6">
                <!-- Quick Stats -->
                <div id="statsPanel" class="hidden bg-white rounded-lg shadow p-5">
                    <h3 class="font-bold mb-3">üìä Ringkasan</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Critical Issues:</span>
                            <span id="statCritical" class="font-bold text-red-600">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Warnings:</span>
                            <span id="statWarning" class="font-bold text-amber-600">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Suggestions:</span>
                            <span id="statInfo" class="font-bold text-blue-600">0</span>
                        </div>
                    </div>
                </div>

                <!-- Manual Checklist -->
                <div class="bg-white rounded-lg shadow p-5">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <span class="text-xl">‚úÖ</span>
                        Checklist Manual
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="border-b pb-2">
                            <p class="font-semibold mb-2 text-red-600">üîí Security (Critical)</p>
                            <label class="flex items-start gap-2">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Input validation & sanitization</span>
                            </label>
                            <label class="flex items-start gap-2 mt-1">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>SQL injection prevention</span>
                            </label>
                            <label class="flex items-start gap-2 mt-1">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>XSS protection</span>
                            </label>
                            <label class="flex items-start gap-2 mt-1">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Authentication check</span>
                            </label>
                            <label class="flex items-start gap-2 mt-1">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Authorization (role-based)</span>
                            </label>
                        </div>

                        <div class="border-b pb-2">
                            <p class="font-semibold mb-2 text-amber-600">üí∞ Payment/Order</p>
                            <label class="flex items-start gap-2">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Amount/price validation</span>
                            </label>
                            <label class="flex items-start gap-2 mt-1">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Double payment prevention</span>
                            </label>
                            <label class="flex items-start gap-2 mt-1">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Transaction atomicity</span>
                            </label>
                            <label class="flex items-start gap-2 mt-1">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Status transition valid</span>
                            </label>
                        </div>

                        <div class="border-b pb-2">
                            <p class="font-semibold mb-2 text-blue-600">‚ö° Performance</p>
                            <label class="flex items-start gap-2">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>No N+1 queries</span>
                            </label>
                            <label class="flex items-start gap-2 mt-1">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Proper indexing</span>
                            </label>
                            <label class="flex items-start gap-2 mt-1">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Pagination implemented</span>
                            </label>
                        </div>

                        <div>
                            <p class="font-semibold mb-2 text-green-600">‚ú® Code Quality</p>
                            <label class="flex items-start gap-2">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Error handling</span>
                            </label>
                            <label class="flex items-start gap-2 mt-1">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Logging appropriate</span>
                            </label>
                            <label class="flex items-start gap-2 mt-1">
                                <input type="checkbox" class="mt-1 rounded">
                                <span>Code readable & maintainable</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Quick Reference -->
                <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg shadow p-5">
                    <h3 class="font-bold mb-3 flex items-center gap-2">
                        <span class="text-xl">üí°</span>
                        Quick Reference
                    </h3>
                    <div class="text-sm space-y-2">
                        <div>
                            <p class="font-semibold text-purple-700">Status Order:</p>
                            <p class="text-xs text-gray-600">pending ‚Üí paid ‚Üí processing ‚Üí shipped ‚Üí completed</p>
                        </div>
                        <div>
                            <p class="font-semibold text-purple-700">User Roles:</p>
                            <p class="text-xs text-gray-600">buyer, seller, admin</p>
                        </div>
                        <div>
                            <p class="font-semibold text-purple-700">Critical Tables:</p>
                            <p class="text-xs text-gray-600">users, orders, order_items, products, shops, transactions</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const reviewBtn = document.getElementById('reviewBtn');
        const clearBtn = document.getElementById('clearBtn');
        const codeInput = document.getElementById('codeInput');
        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');
        const statsPanel = document.getElementById('statsPanel');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');

        // Clear button
        clearBtn.addEventListener('click', () => {
            codeInput.value = '';
            resultsSection.classList.add('hidden');
            statsPanel.classList.add('hidden');
        });

        // Main review function
        reviewBtn.addEventListener('click', async () => {
            const code = codeInput.value.trim();
            if (!code) {
                alert('Silakan masukkan kode terlebih dahulu!');
                return;
            }

            const language = document.getElementById('language').value;
            const module = document.getElementById('module').value;
            const checkSecurity = document.getElementById('check-security').checked;
            const checkBugs = document.getElementById('check-bugs').checked;
            const checkPerformance = document.getElementById('check-performance').checked;
            const checkBestPractice = document.getElementById('check-bestpractice').checked;

            // Show loading
            reviewBtn.disabled = true;
            btnText.classList.add('hidden');
            btnLoader.classList.remove('hidden');
            btnLoader.textContent = 'Analyzing...';
            
            try {
                const prompt = buildPrompt(code, language, module, {
                    security: checkSecurity,
                    bugs: checkBugs,
                    performance: checkPerformance,
                    bestPractice: checkBestPractice
                });

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error:', errorData);
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                const textContent = data.content
                    .filter(block => block.type === 'text')
                    .map(block => block.text)
                    .join('\n');
                
                if (!textContent) {
                    throw new Error('No text content in response');
                }
                
                displayResults(textContent);
                
            } catch (error) {
                console.error('Review Error:', error);
                resultsContent.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-800 font-semibold">‚ùå Error saat melakukan review</p>
                        <p class="text-sm text-red-600 mt-2">${escapeHtml(error.message)}</p>
                        <p class="text-xs text-red-500 mt-2">Cek console browser (F12) untuk detail lebih lanjut.</p>
                    </div>
                `;
                resultsSection.classList.remove('hidden');
            } finally {
                // Hide loading
                reviewBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        });

        function buildPrompt(code, language, module, checks) {
            let focus = [];
            if (checks.security) focus.push('security vulnerabilities');
            if (checks.bugs) focus.push('bugs and errors');
            if (checks.performance) focus.push('performance issues');
            if (checks.bestPractice) focus.push('best practices violations');

            const moduleContext = {
                'auth': 'This is authentication/authorization code for a marketplace. Check for: password hashing, session management, JWT validation, role-based access control (buyer/seller/admin roles).',
                'payment': 'This is payment/checkout code for a marketplace. CRITICAL checks: amount validation, double payment prevention, transaction atomicity, secure payment flow, prevent price manipulation.',
                'order': 'This is order processing code. Check for: status transition validation (pending‚Üípaid‚Üíprocessing‚Üíshipped‚Üícompleted), stock management, race conditions, buyer-seller authorization.',
                'product': 'This is product management code. Check for: image upload security, price validation, seller authorization (only seller can edit their products).',
                'api': 'This is an API endpoint for a marketplace. Check for: input validation, error handling, authentication middleware, rate limiting, proper HTTP status codes.',
                'database': 'This is database code for a marketplace. Check for: SQL injection, N+1 queries, proper indexing, transaction handling, data integrity.',
                'general': 'This is general marketplace code with buyer/seller/admin roles.'
            };

            return `You are a senior code reviewer specializing in e-commerce marketplace security and best practices.

**Context:** ${moduleContext[module] || moduleContext['general']}

**Review Focus:** ${focus.join(', ')}

**Code to Review (${language}):**
\`\`\`${language}
${code}
\`\`\`

**IMPORTANT INSTRUCTIONS:**
1. Analyze the code thoroughly for real issues
2. Consider marketplace-specific risks (payment fraud, unauthorized access, data leaks)
3. Check role-based authorization (buyer vs seller vs admin)
4. Return ONLY valid JSON (no markdown, no code blocks, no extra text)
5. Be specific - mention actual line numbers and code snippets

**Response Format (JSON ONLY):**
{
  "issues": [
    {
      "severity": "critical",
      "category": "security",
      "title": "SQL Injection vulnerability",
      "description": "The query uses string concatenation with user input which allows SQL injection attacks",
      "lineNumber": 3,
      "suggestion": "Use parameterized queries: db.query('SELECT * FROM users WHERE id = ?', [userId])"
    }
  ],
  "summary": "Brief overall assessment"
}

**Severity Levels:**
- "critical": Security holes, data loss, breaking bugs, payment issues
- "warning": Potential bugs, performance problems, bad practices
- "info": Style improvements, optimizations, suggestions

Return ONLY the JSON object, nothing else.`;
        }

        function displayResults(analysisText) {
            console.log('Raw Analysis:', analysisText);
            
            let reviewData;
            
            try {
                // Clean up the response - remove markdown code blocks if present
                let cleanJson = analysisText.trim();
                
                // Remove ```json and ``` if present
                cleanJson = cleanJson.replace(/^```json\s*/i, '').replace(/^```\s*/, '').replace(/\s*```$/, '');
                
                // Try to find JSON object boundaries
                const jsonStart = cleanJson.indexOf('{');
                const jsonEnd = cleanJson.lastIndexOf('}');
                
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    cleanJson = cleanJson.substring(jsonStart, jsonEnd + 1);
                }
                
                console.log('Cleaned JSON:', cleanJson);
                reviewData = JSON.parse(cleanJson);
                
                if (!reviewData.issues || !Array.isArray(reviewData.issues)) {
                    throw new Error('Invalid response structure - missing issues array');
                }
                
            } catch (e) {
                console.error('Parse error:', e);
                console.error('Failed to parse:', analysisText);
                
                // Show the raw response for debugging
                resultsContent.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-yellow-800 font-semibold">‚ö†Ô∏è Response tidak dalam format JSON yang tepat</p>
                        <p class="text-sm text-yellow-700 mt-1">Menampilkan hasil analisis dalam format teks:</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <pre class="text-sm whitespace-pre-wrap font-mono">${escapeHtml(analysisText)}</pre>
                    </div>
                `;
                resultsSection.classList.remove('hidden');
                return;
            }

            const issues = reviewData.issues || [];
            const summary = reviewData.summary || '';

            // Calculate stats
            const stats = {
                critical: issues.filter(i => i.severity === 'critical').length,
                warning: issues.filter(i => i.severity === 'warning').length,
                info: issues.filter(i => i.severity === 'info').length
            };

            document.getElementById('statCritical').textContent = stats.critical;
            document.getElementById('statWarning').textContent = stats.warning;
            document.getElementById('statInfo').textContent = stats.info;
            statsPanel.classList.remove('hidden');

            // Build results HTML
            let html = '';

            if (summary) {
                html += `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p class="font-semibold text-blue-900 mb-1">üìù Ringkasan</p>
                        <p class="text-sm text-blue-800">${escapeHtml(summary)}</p>
                    </div>
                `;
            }

            if (issues.length === 0) {
                html += `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-800 font-semibold">‚úÖ Tidak ada issue yang ditemukan!</p>
                        <p class="text-sm text-green-600 mt-1">Kode terlihat baik. Tetap lakukan manual check untuk memastikan.</p>
                    </div>
                `;
            } else {
                // Sort by severity
                const severityOrder = { critical: 0, warning: 1, info: 2 };
                issues.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);

                issues.forEach((issue, idx) => {
                    const icons = {
                        critical: 'üö®',
                        warning: '‚ö†Ô∏è',
                        info: '‚ÑπÔ∏è'
                    };

                    const bgColors = {
                        critical: 'bg-red-50',
                        warning: 'bg-amber-50',
                        info: 'bg-blue-50'
                    };
                    
                    const borderColors = {
                        critical: 'border-red-500',
                        warning: 'border-amber-500',
                        info: 'border-blue-500'
                    };
                    
                    const textColors = {
                        critical: 'text-red-900',
                        warning: 'text-amber-900',
                        info: 'text-blue-900'
                    };
                    
                    const badgeColors = {
                        critical: 'bg-red-200 text-red-800',
                        warning: 'bg-amber-200 text-amber-800',
                        info: 'bg-blue-200 text-blue-800'
                    };

                    const bgColor = bgColors[issue.severity] || 'bg-gray-50';
                    const borderColor = borderColors[issue.severity] || 'border-gray-500';
                    const textColor = textColors[issue.severity] || 'text-gray-900';
                    const badgeColor = badgeColors[issue.severity] || 'bg-gray-200 text-gray-800';

                    html += `
                        <div class="border-l-4 ${borderColor} ${bgColor} rounded-r-lg p-4 mb-3">
                            <div class="flex items-start justify-between mb-2">
                                <p class="font-semibold ${textColor} flex items-center gap-2">
                                    <span>${icons[issue.severity]}</span>
                                    <span>${escapeHtml(issue.title)}</span>
                                </p>
                                <span class="text-xs ${badgeColor} px-2 py-1 rounded uppercase font-semibold">
                                    ${issue.severity}
                                </span>
                            </div>
                            ${issue.category ? `<p class="text-xs ${textColor} opacity-75 mb-2">üìÇ ${escapeHtml(issue.category)}</p>` : ''}
                            ${issue.lineNumber ? `<p class="text-xs ${textColor} opacity-75 mb-2">üìç Line ${issue.lineNumber}</p>` : ''}
                            <p class="text-sm ${textColor} mb-2">${escapeHtml(issue.description)}</p>
                            ${issue.suggestion ? `
                                <div class="mt-2 bg-white rounded p-3 border ${borderColor} border-opacity-30">
                                    <p class="text-xs font-semibold ${textColor} mb-1">üí° Saran Perbaikan:</p>
                                    <p class="text-sm text-gray-700">${escapeHtml(issue.suggestion)}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }

            resultsContent.innerHTML = html;
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
